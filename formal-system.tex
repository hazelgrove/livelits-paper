\begin{figure*}
        \newcommand{\absgrammar}[2]{c\,|\,$x$\,|\,\hap{#1}{#1}\,|\,\halam{$x$}{#2}{#1}}
        \newcommand{\absgrammargen}[2]{\absgrammar{#1}{#2}\,|\,\hlam{$x$}{#1}\,|\,#1 : #2\,|\,\hehole{\mvar}\,|\,\hhole{#1}{\mvar}}
\begin{grammar}
 Palette definitions
 & $\pDef$
   & $\bnfas$ &
     $\pDefRecord{\dexp}{\htyp}{\htyp}$
%
\\[1ex]
 Basic HTyps
 & $\htyp$
   & $\bnfas$ &
     b\,|\,$\tehole$\,|\,$\tarr{\htyp}{\htyp}$
%
\\[1ex]
 HExps
 & $\hexp$
   & $\bnfas$ &
     $\absgrammargen{\hexp}{\htyp}$
%
\\[1ex]
 IHExps
 & $\dexp$
   & $\bnfas$ &
     $\absgrammar{\dexp}{\htyp}\,|\,\dehole{\mvar}{\subst}{}\,|\,\dhole{\dexp}{\mvar}{\subst}{}$
 \\ &&& $\bnfaltbrk \dcasttwo{\dexp}{\htyp}{\htyp}$
 \\ &&& $\bnfaltbrk \dcastfail{\dexp}{\htyp}{\htyp}$
%
\\[1ex]
 Palette HExps
 & $\pexp$
   & $\bnfas$ &
     $\absgrammargen{\pexp}{\htyp}$
 \\ &&& $\bnfaltbrk \pexpPalLet{\rho}{\pDef}{\pexp}$ & Palette definition $\pDef$ as $\rho$ in $\pexp$
 \\ &&& $\bnfaltbrk \pexpPalAp{\rho}{\dexp}{\htyp}{\pexp}$
                                                & Palette definition $\rho$ expands model $\dexp$ into a function
 \\ &&&                                         & that takes $\pexp$ of type $\htyp$ and returns the resultant HExp
%
\end{grammar}
\hfill \\ \hfill \\ \hfill \\ \hfill \\ TODO where do we define the meanings of $\encExp$, $\downArrowsTo{}{}$, and $\decode{}{}$?
\begin{mathpar}
\newcommand{\dexpand}{\dexp_{\mathsf{expand}}}
\newcommand{\tmodel}{\htyp_{\mathsf{model}}}
\newcommand{\texpansion}{\htyp_{\mathsf{expansion}}}
\newcommand{\dmodel}{\dexp_{\mathsf{model}}}
\newcommand{\denc}{d_{\mathsf{enc}}}
\newcommand{\eexpanded}{\hexp_{\mathsf{expanded}}}
\newcommand{\tsplice}{\htyp_{\mathsf{splice}}}
\newcommand{\psplice}{\pexp_{\mathsf{splice}}}
\newcommand{\esplice}{\hexp_{\mathsf{splice}}}
\\\\
\inferrule[SPELetPal]{
    \pi = \pDefRecord{\dexpand}{\tmodel}{\texpansion} \\\\
    \hasType{\EmptyDelta}{\EmptyhGamma}{\dexpand}{\tarr{\tmodel}{\encExp}} \\ \\
    \pexpandSyn{\hGamma}{\pPhi, \rho : \pi}{\pexp}{\hexp}{\tau}
  }{
    \pexpandSyn{\hGamma}{\pPhi}{\pexpPalLet{\rho}{\pi}{\pexp}}{\hexp}{\tau}
  }
\\\\
\inferrule[SPEApPal]{
    \rho:\pDefRecord{\dexpand}{\tmodel}{\texpansion} \in \pPhi \\\\
    \pexpandAna{\hGamma}{\pPhi}{\psplice}{\esplice}{\tsplice} \\\\
    \hasType{\EmptyDelta}{\EmptyhGamma}{\dmodel}{\tmodel} \\ \\
    \downArrowsTo{\dap{\dexpand}{\dmodel}}{\denc} \\\\
    \decode{\denc}{\eexpanded} \\ \\
    \hana{\EmptyhGamma}{\eexpanded}{\tarr{\tsplice}{\texpansion}}
  }{
    \pexpandSyn{\hGamma}{\pPhi}{\pexpPalAp{\rho}{\dmodel}{\tsplice}{\psplice}}{\hap{\left( \eexpanded : \tarr{\tsplice}{\texpansion} \right)}{\esplice}}{\texpansion}
  }
\\\\
\inferrule[APELetPal]{
    \pi = \pDefRecord{\dexpand}{\tmodel}{\texpansion} \\\\
    \hasType{\EmptyDelta}{\EmptyhGamma}{\dexpand}{\tarr{\tmodel}{\encExp}} \\ \\
    \pexpandAna{\hGamma}{\pPhi, \rho : \pi}{\pexp}{\hexp}{\tau}
  }{
    \pexpandAna{\hGamma}{\pPhi}{\pexpPalLet{\rho}{\pi}{\pexp}}{\hexp}{\tau}
  }
\\
\end{mathpar}
\end{figure*}
