\begin{figure*}
        \newcommand{\absgrammar}[2]{c\,|\,$x$\,|\,\hap{#1}{#1}\,|\,\halam{$x$}{#2}{#1}}
        \newcommand{\absgrammargen}[2]{\absgrammar{#1}{#2}\,|\,\hlam{$x$}{#1}\,|\,#1 : #2\,|\,\hehole{\mvar}\,|\,\hhole{#1}{\mvar}}
\begin{grammar}
 Basic HTyps
 & $\htyp$
   & $\bnfas$ &
     b\,|\,$\tehole$\,|\,$\tarr{\htyp}{\htyp}$
%
\\[1ex]
 HExps
 & $\hexp$
   & $\bnfas$ &
     $\absgrammargen{\hexp}{\htyp}$
%
\\[1ex]
 IHExps
 & $\dexp$
   & $\bnfas$ &
     $\absgrammar{\dexp}{\htyp}\,|\,\dehole{\mvar}{\subst}{}\,|\,\dhole{\dexp}{\mvar}{\subst}{}$
 \\ &&& $\bnfaltbrk \dcasttwo{\dexp}{\htyp}{\htyp}$
 \\ &&& $\bnfaltbrk \dcastfail{\dexp}{\htyp}{\htyp}$
%
\\[1ex]
 Palette definitions
 & $\pDef$
   & $\bnfas$ &
     $\pDefRecord{\dexp}{\htyp}{\htyp}$
%
\\[1ex]
 Palette HExps
 & $\pexp$
   & $\bnfas$ &
     $\absgrammargen{\pexp}{\htyp}$
 \\ &&& $\bnfaltbrk \pexpPalLet{\rho}{\pDef}{\pexp}$ & Palette definition $\pDef$ as $\rho$ in $\pexp$
 \\ &&& $\bnfaltbrk \pexpPalAp{\rho}{\dexp}{x}{(\htyp, \pexp)}{C}$
                                                & $\dexp$ is a model that is expanded by palette definition $\rho$
 \\ &&&                                         & into an encoding of the resultant HExp
%
\end{grammar}
\hfill \\ \hfill \\ \hfill \\ \hfill \\ TODO where do we define the meanings of $\encExp$ and $\decode{}{}$?
\begin{mathpar}
\newcommand{\dexpand}{\dexp_{expand}}
\newcommand{\tmodel}{\tau_{model}}
\newcommand{\texpansion}{\tau_{expansion}}
\newcommand{\dmodel}{\dexp_{model}}
\newcommand{\htypx}{\htyp_x}
\newcommand{\pexpx}{\pexp_x}
\newcommand{\hexpx}{\hexp_x}
\\\\
\inferrule[SPELetPal]{
    \pi = \pDefRecord{\dexpand}{\tmodel}{\texpansion} \\\\
    \hasType{\EmptyDelta}{\EmptyhGamma}{\dexpand}{\tarr{\tmodel}{\encExp}} \\ \\
    \pexpandSyn{\hGamma}{\pPhi, \rho : \pi}{\pexp}{\hexp}{\tau}
  }{
    \pexpandSyn{\hGamma}{\pPhi}{\pexpPalLet{\rho}{\pi}{\pexp}}{\hexp}{\tau}
  }
\\\\
\inferrule[SPEApPal]{
    \rho:\pDefRecord{\dexpand}{\tmodel}{\texpansion} \in \pPhi \\\\
    \forall x \in C, \left( \pexpandAna{\hGamma}{\pPhi}{\pexpx}{\hexpx}{\htypx} \right) \\\\
    \hasType{\EmptyDelta}{\EmptyhGamma}{\dmodel}{\tmodel} \\ \\
    \multiStepsTo{\dap{\dexpand}{\dmodel}}{enc} \\\\
    \decode{enc}{\hexp} \\ \\
    \hana{\fmap{x}{C}{\htypx}}{\hexp}{\texpansion}
  }{
    \pexpandSyn{\hGamma}{\pPhi}{\pexpPalAp{\rho}{\dmodel}{x}{(\htypx, \pexpx)}{C}}{\substitutesub{\hexpx}{x}{x \in C}{e}}{\texpansion}
  }
\\\\
\inferrule[APELetPal]{
    \pi = \pDefRecord{\dexpand}{\tmodel}{\texpansion} \\\\
    \hasType{\EmptyDelta}{\EmptyhGamma}{\dexpand}{\tarr{\tmodel}{\encExp}} \\ \\
    \pexpandAna{\hGamma}{\pPhi, \rho : \pi}{\pexp}{\hexp}{\tau}
  }{
    \pexpandAna{\hGamma}{\pPhi}{\pexpPalLet{\rho}{\pi}{\pexp}}{\hexp}{\tau}
  }
\\
\end{mathpar}
\end{figure*}
